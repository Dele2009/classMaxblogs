<!DOCTYPE html>
<html lang="en">
    <%- include ('../main_app_head') %>

<body id="">
        <%- include ('../main_app_header') %>
        <%-include('../Alertbox')%>
<style>
   

    

    .message-container {
        overflow-y: scroll;
        max-height: 400px;
        padding: 10px;
    }

    .message {
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 10px;
        max-width: 50%;
        width: fit-content;
    }

    .own-message {
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 10px;
        max-width: 50%;
        width: fit-content;

        
       
        
    }

    .message-sender {
        font-weight: bold;
        margin-bottom: 2px;
        font-size: 11px;
    }

    .message-text {
        word-wrap: break-word;
    }

    .input-container {
        display: flex;
        background-color: #fff;
        border-top: 1px solid #ccc;
        padding: 10px;
    }

    .input-field {
        flex: 1;
        padding: 8px;
        border: none;
        border-radius: 5px;
        outline: none;
    }

    .send-btn {
       
        color: #fff;
        
        
        margin-left: 10px;
        cursor: pointer;
        
    }
</style>

<div id="wrapper">

    <!-- Sidebar -->
    <%- include ('../sidebar')%>
    <!-- End of Sidebar -->

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column w-100">

        <!-- Main Content -->
        <div class="position-fixed bottom-0 w-100">
            <div class="message-container">
                
                    
                        <% messages.map(message=> { %>
                            <% if (message.senderId==User._id) { %>
                                <div class="own-message ms-auto bg-primary text-light ">
                                    <div class="message-sender">
                                        You <span class="ms-auto"><%= message.time %></span>
                                    </div>
                                    <div class="message-text">
                                        <%= message.message %>
                                    </div>
                                </div>
                            <% } else { %>
                                    <div class="message bg-primary text-light">
                                        <div class="message-sender">
                                            <%= Recipient.name %> <span class="ms-auto"><%= message.time %></span>
                                        </div>
                                        <div class="message-text">
                                            <%= message.message %>
                                        </div>
                                    </div>
                            <% } %>
                        <% }) %>
                    
            </div>
            
            <div class="input-container ">
                <input type="text" id="message-input" class="input-field" placeholder="Type your message...">
                <button id="send-btn" class="send-btn btn btn-primary"><i class="fa fa-paper-plane"></i></button>
            </div>
          
        </div>
        <!-- End of Main Content -->
        <%- include ('./modal')%>
        <!-- Footer -->
        <%- include ('./footer')%>

        <!-- End of Footer -->

    </div>
    <!-- End of Content Wrapper -->

</div>
<!-- End of Page Wrapper -->

<!-- Scroll to Top Button-->
<!-- <a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
</a> -->


<script src="/socket.io/socket.io.js"></script>
<script>
    // In the frontend JavaScript
    const socket = io();

    const userId = "<%= User._id %>";
    const receiverId = "<%= Recipient._id %>"
    socket.emit('setUser', userId);


    document.getElementById('send-btn').addEventListener('click', () => {
        const messageInput = document.getElementById('message-input');
        const content = messageInput.value.trim();
        if (content !== '') {
            // socket.emit('sendMessage', { senderId: userId, receiverId, content });
            socket.emit('sendMessage', {
                senderId: userId,
                receiverId: receiverId,
                message: content
            });
            messageInput.value = '';
        }
    });

    socket.on('receiveMessage', (message) => {
        if (message.senderId === receiverId || message.senderId === userId) {            
            const messageContainer = document.querySelector('.message-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = message.senderId === userId ? 'own-message ms-auto bg-primary text-light' : 'message bg-primary text-light';
            const messageText = document.createElement('div');
            const date = new Date()
            const hour = date.getHours()
            const minute = date.getMinutes()
            const newMinute = minute < 10 ? "0" + minute : minute
            const md = hour < 12 ? "am" : "pm";
            const newHour = hour > 12 ? hour - 12 : hour

            const timeElement = `<span class="ms-auto">${newHour}:${newMinute} ${md}</span>`

            messageText.innerHTML = message.senderId===userId ? `
                <div class="message-sender">You ${timeElement}</div> 
                <div class="message-text">${message.message}</div>

                `:`
                
                <div class="message-sender"><%= Recipient.name %> ${timeElement}</div> 
                <div class="message-text">${message.message}</div>`
            ;
            
                
        
            messageDiv.appendChild(messageText);
            messageContainer.appendChild(messageDiv);
        }


    //     if (message.sender === receiverId || message.sender === userId) {
    //     const messageElement = document.createElement('div');
    //     messageElement.innerHTML = `<strong>${message.sender}</strong>: ${message.message}`;
    //     document.getElementById('messages').appendChild(messageElement);
    //   }
    });
</script>
<%- include ('../scripts')%>
</body>
</html>